---
title: "Argo Workflowå…¥é–€"
emoji: "ğŸ¦‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ArgoWorkflow"]
published: true
---

Argo Workflowã‚’è§¦ã£ã¦ã¿ãŸã®ã§ã€èª¿ã¹ãŸã“ã¨ã‚’è»½ãã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

# æ¦‚å¿µ
Argo Workflowã‚’ä½¿ã†ä¸Šã§å‡ºã¦ãã‚‹æ¦‚å¿µã¨ã—ã¦ã¯ã–ã£ãã‚Šä»¥ä¸‹ã§ã™ã€‚è©³ç´°ã¯[Core Concepts](https://argoproj.github.io/argo-workflows/workflow-concepts/)ã‚’å‚ç…§ãã ã•ã„ã€‚

## Workflow
- Kubernetesä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹workflowã‚’å®šç¾©ã™ã‚‹
- workflowã®stateã‚’ä¿ç®¡ã—ã¦ã„ã‚‹

Workflowã¯é™çš„ãªå®šç¾©ãªã ã‘ã§ãªãã€å®šç¾©ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚‚ã‚ã‚‹

## Workflow Spec
å®Ÿè¡Œã•ã‚Œã‚‹workflowã¯ `Workflow.spec` ã§å®šç¾©ã§ãã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã€‚
- `templates` ã¯é–¢æ•°ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã€å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã®å†…å®¹ãŒã¾ã¨ã¾ã£ã¦ã„ã‚‹ã€‚
- `entrypoint` ã¯workflowå®Ÿè¡Œæ™‚ã«ä¸€ç•ªæœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹templateã®ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: hello-world
spec:
  entrypoint: whalesay
  templates:
  - name: whalesay
    container:
      image: docker/whalesay
      command: [cowsay]
      args: ["hello world"]
```


ã¡ãªã¿ã«templateã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã‚‹ï¼ˆä»¥ä¸‹ä»¥å¤–ã«ã‚‚ã‚ã‚‹ï¼‰ã€‚

### container
    - ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç›´æ¥æŒ‡å®šã™ã‚‹
```yaml
...
- name: whalesay
container:
  image: docker/whalesay
  command: [cowsay]
  args: ["hello world"]
```

### script
    - containerã«åŠ ãˆã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡ŒãŒã§ãã‚‹
```yaml
- name: gen-random-int
script:
  image: python:alpine:3.6
  command: [python]
  source: |
    import random
    i = random.randint(1, 100)
    print(i)
```

### resource
    - Kubernetesã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç›´æ¥å®Ÿè¡Œã§ãã‚‹

```yaml
...
- name: k8s-owner-reference
  resource:
    action: create
    manifest: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        generateName: owner
```

### steps
  - è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã‚’å®šç¾©ã§ãã‚‹
  - ãƒã‚¹ãƒˆã—ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ã‚‚ã§ãã€ãã®å ´åˆã«ã¯å†…å´ã®å‡¦ç†ã¯ä¸¦è¡Œã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
  - ä»¥ä¸‹ã®å ´åˆã«ã¯ `step2a` ã¨ `step2b` ã¯ä¸¦è¡Œã—ã¦è¡Œã‚ã‚Œã‚‹
  - [clauses to conditionally execute a step](https://argoproj.github.io/argo-workflows/examples/coinflip.yaml)ã«ã‚ã‚‹ã‚ˆã†ã«ã€ `when` ã§ã®åˆ¶å¾¡ã‚‚ã§ãã‚‹ã‚‰ã—ã„ã€‚

```yaml
...
- name: hello-world
  steps:
    - - name: step1
        template: prepare-data
    - - name: step2a
        template: run-data-parallel-1
    - - name: step2b
        template: run-data-parallel-2
```

## RBAC
Argo Workflowã‹ã‚‰workflowã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ã¯Kubernetes APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€KubernetesãŒæä¾›ã—ã¦ã„ã‚‹ServiceAccountã‚’ä½¿ã£ã¦RBACã‚’çµŒç”±ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚
`workflow.spec.serviceAccountName` ã«è¨­å®šã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã™ã‚‹workflowã«ä»˜ä¸ã§ãã‚‹ãŒã€ çœç•¥ã—ãŸå ´åˆã«ã¯KubernetesãŒæä¾›ã—ã¦ã„ã‚‹defaultã®ServiceAccountãŒä½¿ç”¨ã•ã‚Œã‚‹ã€‚

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: workflow-role
rules:
  - apiGroups:
      - ""
    resources:
      - pods
    verbs: ["get", "watch", "patch"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: workflow-sa
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: workflow-rolebinding
subjects:
  - kind: ServiceAccount
    name: workflow-sa
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: workflow-role
---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: hello-whale
spec:
  entrypoint: whalesay
  serviceAccountName: workflow-sa # å®Ÿè¡Œã™ã‚‹Workflowã«å¯¾ã—ã¦ä»˜ä¸ã§ãã‚‹
  templates:
    - name: whalesay
      container:
        image: docker/whalesay
        command: [cowsay]
        args: ["hello world"]
```

## WorkflowTemplates
WorkflowTemplatesã¯å†åˆ©ç”¨å¯èƒ½ãªWorkflowã‚’å®šç¾©ã§ãã‚‹ã€‚
ç›´æ¥submitã—ãŸã‚Šä»–ã®Workflowã‹ã‚‰å‚ç…§ã—ãŸã‚Šã§ãã‚‹ã€ã„ã‚ã°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®ã‚ˆã†ãªã‚‚ã®ã§ã‚ã‚‹ã€‚
[Referencing other WorkflowTemplates](https://argoproj.github.io/argo-workflows/workflow-templates/#referencing-other-workflowtemplates) ã«ã‚ã‚‹ã‚ˆã†ã«ã€ `WorkflowTemplates` ã® `templates` ã‚’ä»–ã®Workflowã‹ã‚‰å‚ç…§ã§ãã‚‹ï¼ˆãã®éš›ã«ã¯ `templateRef` ã‚’ä½¿ç”¨ã™ã‚‹ï¼‰ã€‚

```yaml
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: workflow-template-submittable
spec:
  arguments:
    parameters:
      - name: message
        value: hello world
  templates:
    - name: whalesay-template
      inputs:
        parameters:
          - name: message
      container:
        image: docker/whalesay
        command: [cowsay]
        args: ["{{inputs.parameters.message}}"]
---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: workflow-template-hello-world-
spec:
  entrypoint: whalesay
  templates:
  - name: whalesay
    steps:                              # You should only reference external "templates" in a "steps" or "dag" "template".
      - - name: call-whalesay-template
          templateRef:                  # You can reference a "template" from another "WorkflowTemplate" using this field
            name: workflow-template-1   # This is the name of the "WorkflowTemplate" CRD that contains the "template" you want
            template: whalesay-template # This is the name of the "template" you want to reference
          arguments:                    # You can pass in arguments as normal
            parameters:
            - name: message
              value: "hello world"
```

Argo Workflow v2.9ä»¥é™ã§ã¯ `WorkflowTemplate` ã‹ã‚‰ `Workflow` ã‚’ä½œã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: workflow-template-hello-world-
spec:
  # entrypointã¨argumentsã‚’æ¸¡ã—ã¤ã¤`workflow-template-submittable`ã‚’å‘¼ã³å‡ºã™
  entrypoint: whalesay-template
  arguments:
    parameters:
      - name: message
        value: "from workflow"
  workflowTemplateRef:
    name: workflow-template-submittable
---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: workflow-template-hello-world-
spec:
  # WorkflowTemplatesã§å®šç¾©ã—ãŸã‚‚ã®ã‚’ãã®ã¾ã¾å‘¼ã³å‡ºã™
  workflowTemplateRef:
    name: workflow-template-submittable
```

# å‚è€ƒ
- [argoproj/argo-workflows](https://github.com/argoproj/argo-workflows)
- [Argo Documentation](https://argoproj.github.io/argo-workflows/)

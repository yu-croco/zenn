---
title: "ぼくのかんがえるKubernetes(EKS)のツラミと理想のターゲット"
emoji: "🌊"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["Kubernetes"]
published: false
---

Kubernetes（EKS）を業務で使い始めてほんの少し感覚が掴めてきました。Kubernetes(EKS)の使い所を自分なりにまとめました。
技術導入を検討されている方の手助けになれば幸いです。

# 前提
- ここの記事で記載している `Kubernetes` とは主にAWSのEKS(またはその他のマネージド・サービスでのKubernetes)であり、自前運用の素のKubernetesのことではありません。
- ネガティブなポイントを多く記載していますが、これはEKSをディスりたいための記事ではありません
  - EKSは非常に便利で強力ですが銀の弾丸では決して無く、自分たちの目的に合う場合に使うのが良いということを伝えたいための記事です

# ツラミ
## 1. 必要な知見の幅が広すぎる
Kubernetesを使ってシステム運用を行う場合、Kubernetesそれ単体では開発や運用はまわりません。その他にCNCFが提供している周辺エコシステムやクラウドインフラ固有の知見が必要となります。
少し古い記事ですがこちらに周辺エコシステムがまとまっていました。 [Kubernetesのエコシステム ー その他雑多](https://www.kaitoy.xyz/2019/09/23/k8s-ecosystem-misc/)

例えば代表的なものだと以下のような技術スタックが必要になるかと思います。

- Kubernetes(EKS)
    - Kubernetes標準機能
    - クラウドインフラ特有の事項（例えばEKSであればIRSA, aws-auth, OIDCなどなど）
- Helm
  - パッケージマネージャーなくプロジェクトを管理するのはほぼ無理ではないかと思います
- ArgoCD
  - デプロイもKubernetes単体では管理するのが非常に難しいです
- Gatekeeper
  - マニフェストに特有の制約を課したくなる場合にはこういったツールが欠かせません
- Terraform(またはクラウドベンダーが出しているIaC)
  - Kubernetes用の構成を理解して管理する必要があります

またKubernetes自体は非常に情報が揃ってきていますが、その周辺のエコシステムは基本的に情報があまり出回っていません。
英語での1次情報収集は当たり前として、時にはツールの内部実装を見に行かないといけないケースもあります。

## 2. システムの土台が必然的に大規模になる
どのようなIaCを使ってもKubernetesをセットアップすることだけで非常に大きなリソースの準備が必要になります。
特にKubernetesの権限を細かく絞ろうとすると（本来そうすべきです）特に初期における手間のかかり具合は大きいかなと思います。
それを考えるとたとえ本当にミニマム構成であったとしても、ECSなどの構成と比べると遥かに沢山のリソースが必要となります。

## 3. バージョンアップデートが頻繁にある
[Amazon EKS Kubernetes バージョン](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/kubernetes-versions.html) を見る限り、EKSは約3~4ヶ月に1度バージョンアップデートがあり、それに追従していく必要があります。

![](https://storage.googleapis.com/zenn-user-upload/jq9yzkfw35e1lesae0oo71k8o8rq)

また[Amazon EKS 最適化 Amazon Linux AMI バージョン](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eks-linux-ami-versions.html)にあるように、EKS用のEC2のバージョン更新も頻繁に行われています。
*昨今ではFargateも出てきていますが、起動速度の問題や使用できるリソースに制限があることから、必ずしもFargateを使えるわけではないと思います。

その上、運用で使用しているその他のツール（HelmやArgoCDなど）のバージョンアップも必要となるため、中長期的な運用を考えるとこちらも片手間で行なうのは難しいかと思います。

## 4. クラウドインフラの固定費がかさむ
EKSではアプリケーションなどを動かすノード（EC2 or Fargate）単位でも費用が発生しますが、クラスターそのものの費用もかかります。

[Amazon EKS の料金表](https://aws.amazon.com/jp/eks/pricing/) によると、

> 作成した個々の Amazon EKS クラスターについて、毎時課金 0.10USD されます。

とのことで、クラスター毎に$72/月かかります。
もちろんちゃんと構成するには環境毎（本番、ステージング、検証、etc.）にクラスターを分けますし、シングルノードで動かすことも少ないでしょう。


# おすすめしないターゲット層
ツラミで紹介した点を元に、おすすめしないケースをまとめました。

## 人員/資金に余裕がない場合
固定費も学習コストも高いため、一般的なスタートアップには向いていないと考えています。費用削減のために1クラスター上にnamespaceで環境を分割するようなことは絶対におすすめしません。
定期的なバージョンアップ対応などで結局は同じ状態の複数環境が必要であり、中長期的に見て痛い目を見ると思います。もちろん構築はできると思いますが、バージョンの追従やアプリケーションのデプロイを考えると徐々にクラウドインフラがペット化していくのではないかと思います。

## システムアーキテクチャがプロダクトの競争優位性に寄与しずらい場合
一般的な構成のwebサービスにとってはEKSはオーバースペックであると思っています。世間がクラウドネイティブだ何だと言ってるからと言って、無理してナウでイケてる方式を採用する必要はないと思います。
特にコンテナを採用する方針であれば、AWSであればECSがあります。つい最近AWSはECS内のコンテナにアクセスするための機能をリリースしたりと、こちらもかなり進化が速いです。[NEW – Using Amazon ECS Exec to access your containers on AWS Fargate and Amazon EC2](https://aws.amazon.com/jp/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/)

「EKSでサービス展開してるけど、シングルノードです！」みたいなのは本当に宝の持ち腐れだと思うので、よりコストパフォーマンスの良い技術スタックを使うのが良いのではないかと思います。

## （クラウド）インフラ専任のチームが無い場合
既述の通り、必要とされる知識の量が非常に多いこと、また頻繁なアップデートなどの対応を考えると、バックエンドエンジニアが片手間で構築/運用するのは非常に非効率であると思っています

# おすすめするターゲット層
おすすめしないケースに当てはまらない条件の上で、以下の条件にマッチする場合にはEKSを最大限に有効活用できるのではないかと思っています。

## サービス全体の複雑度が高い場合
マイクロサービスがその代表例だと思います。 そもそもKubernetesが生まれた背景には複雑化するコンテナ管理があったと思います。
例えば金融系のシステムであれば数十/数百のシステムが連動して動いている場合もあります。こういった巨大なサービス群を管理するには非常に強力な技術だと思います。

とまぁ「それ知ってる」という感じの内容だったかもしれないが、ほんとそのとおりだと思います。
モダンだの何だのって言葉に踊らされた技術選定はせず、地に足つけて基本に忠実にやっていくべきだと思います。

# 雑感
EKSは本当に強力な技術だけど、その分使うの難しい